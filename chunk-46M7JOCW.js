import{a as l}from"./chunk-MPWYS2KC.js";import{Ib as m,f as n,p as c,s as u,zb as h}from"./chunk-KKTR3JM6.js";var v=(()=>{let i=class i{constructor(e,r){this.http=e,this.router=r,this.apiUrl=`${l.apiUrl}/auth`,this.currentUserSubject=new n(null),this.currentUser$=this.currentUserSubject.asObservable(),this.permisosSubject=new n(null),this.permisos$=this.permisosSubject.asObservable(),this.checkAuthStatus()}checkAuthStatus(){let e=localStorage.getItem("token"),r=localStorage.getItem("user");if(e&&r)try{if(this.isTokenValid(e)){let t=JSON.parse(r);this.currentUserSubject.next(t),setTimeout(()=>{this.cargarPermisosDelRol()},100)}else this.clearAuthData()}catch{this.clearAuthData()}}clearAuthData(){localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("rememberMe"),localStorage.removeItem("permisos"),localStorage.removeItem("demoTimeInfo"),this.currentUserSubject.next(null),this.permisosSubject.next(null)}login(e,r,t=!1){let s={username:e,password:r,rememberMe:t};return this.http.post(`${this.apiUrl}/login`,s)}logout(){this.clearAuthData(),this.router.navigate(["/login"])}verifyToken(){return this.http.get(`${this.apiUrl}/verify`)}getProfile(){return this.http.get(`${this.apiUrl}/profile`)}changePassword(e,r){return this.http.post(`${this.apiUrl}/change-password`,{currentPassword:e,newPassword:r})}isAuthenticated(){let e=localStorage.getItem("token");return e?this.isTokenValid(e):!1}cargarPermisosDelRol(){let e=this.getCurrentUser();if(!e||!e.rol){this.permisosSubject.next(null);return}if(this.isSuperAdmin()){let t={trabajadores:{ver:!0,crear:!0,editar:!0,eliminar:!0},planillas:{ver:!0,crear:!0,editar:!0,eliminar:!0},reportes:{ver:!0,exportar:!0},configuracion:{ver:!0,editar:!0},asistencia:{ver:!0,editar:!0},beneficios:{ver:!0,editar:!0},prestamos:{ver:!0,crear:!0,editar:!0,eliminar:!0},usuarios:{ver:!0,crear:!0,editar:!0,eliminar:!0},roles:{ver:!0,crear:!0,editar:!0,eliminar:!0}};this.permisosSubject.next(t),localStorage.setItem("permisos",JSON.stringify(t));return}let r=localStorage.getItem("permisos");if(r)try{let t=JSON.parse(r);this.permisosSubject.next(t)}catch(t){console.error("Error al parsear permisos guardados:",t)}this.http.get(`${l.apiUrl}/roles/nombre/${encodeURIComponent(e.rol)}`).subscribe({next:t=>{if(t.success&&t.data){let s=t.data.permisos;if(Array.isArray(s)&&s.length===1&&s[0]==="*")s={trabajadores:{ver:!0,crear:!0,editar:!0,eliminar:!0},planillas:{ver:!0,crear:!0,editar:!0,eliminar:!0},reportes:{ver:!0,exportar:!0},configuracion:{ver:!0,editar:!0},asistencia:{ver:!0,editar:!0},beneficios:{ver:!0,editar:!0},prestamos:{ver:!0,crear:!0,editar:!0,eliminar:!0},usuarios:{ver:!0,crear:!0,editar:!0,eliminar:!0},roles:{ver:!0,crear:!0,editar:!0,eliminar:!0}};else if(typeof s=="string")try{s=JSON.parse(s)}catch(p){console.error("Error al parsear permisos JSON:",p),s={}}(!s||typeof s!="object"||Array.isArray(s))&&(s={}),this.permisosSubject.next(s),localStorage.setItem("permisos",JSON.stringify(s));let a=this.getCurrentUser();a&&(a.permisos=s,this.currentUserSubject.next(a),localStorage.setItem("user",JSON.stringify(a)))}else this.permisosSubject.next({})},error:t=>{console.error("Error al cargar permisos del rol:",t),this.permisosSubject.next({})}})}getPermisos(){return this.permisosSubject.value}hasPermission(e,r){if(this.isSuperAdmin())return!0;let t=this.getPermisos();return!t||!t[e]?!1:t[e][r]===!0}canView(e){return this.hasPermission(e,"ver")}canCreate(e){return this.hasPermission(e,"crear")}canEdit(e){return this.hasPermission(e,"editar")}canDelete(e){return this.hasPermission(e,"eliminar")}canExport(){return this.hasPermission("reportes","exportar")}isTokenValid(e){try{let r=this.parseJwt(e),t=Date.now()/1e3;return r.exp&&r.exp>t}catch{return!1}}getToken(){return localStorage.getItem("token")}getCurrentUser(){return this.currentUserSubject.value}hasRole(e){let r=this.getCurrentUser();return r?r.rol===e:!1}isSuperAdmin(){let e=this.getCurrentUser();if(!e)return!1;let r=(e.rol||"").toUpperCase();return r==="SUPER ADMINISTRADOR"||r==="SUPER_ADMINISTRADOR"||r==="SUPER_ADMIN"||e.rol==="Super Administrador"}isAdmin(){let e=this.getCurrentUser();if(!e)return!1;if(this.isSuperAdmin())return!0;let r=(e.rol||"").toUpperCase();return r==="ADMINISTRADOR"||r==="ADMIN"||r==="ADMIN_NORMAL"||e.rol==="Administrador"}isRRHH(){return this.canView("trabajadores")||this.canCreate("trabajadores")?!0:this.hasRole("RRHH")||this.isAdmin()}isContabilidad(){return this.canView("planillas")||this.canCreate("planillas")?!0:this.hasRole("Contabilidad")||this.hasRole("CONTABILIDAD")||this.isAdmin()}isGerencia(){return this.canView("trabajadores")&&!this.canCreate("trabajadores")&&!this.canEdit("trabajadores")?!0:this.hasRole("Gerencia")||this.hasRole("GERENCIA")||this.isAdmin()}isDemo(){return this.hasRole("DEMO")||this.hasRole("demo")}parseJwt(e){try{let t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),s=decodeURIComponent(atob(t).split("").map(a=>"%"+("00"+a.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(s)}catch{return null}}saveAuthData(e,r,t=!1){localStorage.setItem("token",e),localStorage.setItem("user",JSON.stringify(r)),t&&localStorage.setItem("rememberMe","true"),this.currentUserSubject.next(r),setTimeout(()=>{this.cargarPermisosDelRol()},100)}shouldRememberSession(){return localStorage.getItem("rememberMe")==="true"}};i.\u0275fac=function(r){return new(r||i)(u(h),u(m))},i.\u0275prov=c({token:i,factory:i.\u0275fac,providedIn:"root"});let o=i;return o})();export{v as a};
