<div class="boletas-pago">
  <!-- HEADER -->
  <div class="page-header">
    <div class="page-header__left">
      <h1 class="page-title">
        <span class="page-title__icon">ğŸ“„</span>
        Boletas de Pago
      </h1>
      <p class="page-subtitle">
        <span class="page-subtitle__dots">
          <span class="page-subtitle__dot page-subtitle__dot--large"></span>
          <span class="page-subtitle__dot page-subtitle__dot--medium"></span>
          <span class="page-subtitle__dot page-subtitle__dot--small"></span>
        </span>
        Consulta y gestion de boletas de remuneraciones
      </p>
    </div>
    <div class="page-header__right">
      <button 
        class="btn btn--sm btn--primary" 
        (click)="enviarTodasLasBoletas()"
        [disabled]="cargando || boletasFiltradas.length === 0"
        title="Enviar todas las boletas por correo electrÃ³nico"
      >
        ğŸ“§ Enviar Todas por Email
      </button>
      <button class="btn btn--sm btn--outline" (click)="exportarExcel()">
        ğŸ“Š Exportar Excel
      </button>
      <button 
        class="btn btn--sm btn--outline" 
        (click)="modoSeleccion = !modoSeleccion"
        [class.active]="modoSeleccion"
      >
        {{ modoSeleccion ? 'âœ–ï¸ Cancelar Seleccion' : 'â˜‘ï¸ Seleccion Masiva' }}
      </button>
    </div>
  </div>

  <!-- RESUMEN -->
  <div class="resumen-boletas" *ngIf="resumen">
    <div class="resumen-card resumen-card--total">
      <div class="resumen-card__icon">ğŸ“‹</div>
      <div class="resumen-card__content">
        <span class="resumen-card__label">Total Boletas</span>
        <span class="resumen-card__value">{{ resumen.totalBoletas }}</span>
      </div>
    </div>

    <div class="resumen-card resumen-card--enviadas">
      <div class="resumen-card__icon">ğŸ“§</div>
      <div class="resumen-card__content">
        <span class="resumen-card__label">Enviadas</span>
        <span class="resumen-card__value">{{ resumen.boletasEnviadas }}</span>
      </div>
    </div>

    <div class="resumen-card resumen-card--descargadas">
      <div class="resumen-card__icon">ğŸ“¥</div>
      <div class="resumen-card__content">
        <span class="resumen-card__label">Descargadas</span>
        <span class="resumen-card__value">{{ resumen.boletasDescargadas }}</span>
      </div>
    </div>

    <div class="resumen-card resumen-card--trabajadores">
      <div class="resumen-card__icon">ğŸ‘¥</div>
      <div class="resumen-card__content">
        <span class="resumen-card__label">Trabajadores</span>
        <span class="resumen-card__value">{{ resumen.totalTrabajadores }}</span>
      </div>
    </div>

    <div class="resumen-card resumen-card--neto">
      <div class="resumen-card__icon">ğŸ’°</div>
      <div class="resumen-card__content">
        <span class="resumen-card__label">Total Neto Pagado</span>
        <span class="resumen-card__value">S/. {{ resumen.totalNetoPagado.toFixed(2) }}</span>
      </div>
    </div>
  </div>

  <!-- ACCIONES MASIVAS -->
  <div class="acciones-masivas" *ngIf="modoSeleccion && boletasSeleccionadas.length > 0">
    <div class="acciones-masivas__info">
      <span class="acciones-masivas__count">{{ boletasSeleccionadas.length }} boletas seleccionadas</span>
      <button class="btn-link" (click)="deseleccionarTodas()">Deseleccionar todas</button>
    </div>
    <div class="acciones-masivas__buttons">
      <button class="btn btn--sm btn--primary" (click)="abrirEnvioMasivo()">
        ğŸ“§ Enviar por Email
      </button>
      <button class="btn btn--sm btn--outline" (click)="descargarMasivo()">
        ğŸ“¥ Descargar ZIP
      </button>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="filtros-section">
    <div class="filtros-header">
      <div class="filtros-header__left">
        <h3 class="filtros-title">ğŸ” Filtros de Busqueda</h3>
      </div>
      <div class="filtros-header__right">
        <div class="vista-toggle">
          <button 
            class="btn btn--sm btn--view-toggle" 
            [class.active]="vistaActual === 'lista'"
            (click)="vistaActual = 'lista'"
          >
            ğŸ“‹ Lista
          </button>
          <button 
            class="btn btn--sm btn--view-toggle" 
            [class.active]="vistaActual === 'tarjetas'"
            (click)="vistaActual = 'tarjetas'"
          >
            ğŸ—‚ï¸ Tarjetas
          </button>
        </div>
        <button class="btn btn--ghost btn--sm" (click)="limpiarFiltros()">
          âœ–ï¸ Limpiar
        </button>
      </div>
    </div>

    <div class="filtros-grid">
      <div class="filtro-item">
        <label class="filtro-label">AÃ±o:</label>
        <select class="filtro-select" [(ngModel)]="filtros.anio" (change)="onFiltroChange()">
          <option *ngFor="let anio of anios" [value]="anio">{{ anio }}</option>
        </select>
      </div>

      <div class="filtro-item">
        <label class="filtro-label">Mes:</label>
        <select class="filtro-select" [(ngModel)]="filtros.mes" (change)="onFiltroChange()">
          <option *ngFor="let mes of mesesBoletas" [value]="mes.valor">{{ mes.nombre }}</option>
        </select>
      </div>

      <div class="filtro-item">
        <label class="filtro-label">Estado:</label>
        <select class="filtro-select" [(ngModel)]="filtros.estado" (change)="onFiltroChange()">
          <option *ngFor="let estado of estadosBoleta" [value]="estado">{{ estado }}</option>
        </select>
      </div>

      <div class="filtro-item">
        <label class="filtro-label">Area:</label>
        <select class="filtro-select" [(ngModel)]="filtros.area" (change)="onFiltroChange()">
          <option *ngFor="let area of areas" [value]="area">{{ area }}</option>
        </select>
      </div>

      <div class="filtro-item filtro-item--search">
        <div class="search-box-wrapper">
          <label class="filtro-label">Buscar:</label>
          <div class="search-box">
            <span class="search-box__icon">ğŸ”</span>
            <input
              type="text"
              class="search-box__input"
              placeholder="Buscar por DNI, nombre, codigo..."
              [(ngModel)]="filtros.busqueda"
              (input)="onBusquedaChange()"
            />
          </div>
        </div>
        <span class="resultado-texto">
          Mostrando <strong>{{ boletasFiltradas.length }}</strong> boletas
          <span *ngIf="filtros.mes !== 0"> de <strong>{{ nombreMesFiltro }}</strong></span>
          <strong>{{ filtros.anio }}</strong>
        </span>
      </div>
    </div>
  </div>

  <!-- VISTA LISTA -->
  <div class="tabla-container" *ngIf="vistaActual === 'lista'">
    <div class="tabla-scroll">
      <table class="tabla">
        <thead>
          <tr>
            <th *ngIf="modoSeleccion">
              <input 
                type="checkbox" 
                class="checkbox-input"
                [checked]="boletasSeleccionadas.length === boletasPaginadas.length && boletasPaginadas.length > 0"
                (change)="$event.target.checked ? seleccionarTodas() : deseleccionarTodas()"
              />
            </th>
            <th>Codigo</th>
            <th>Trabajador</th>
            <th>DNI</th>
            <th>Area</th>
            <th>Periodo</th>
            <th>Total Ingresos</th>
            <th>Total Descuentos</th>
            <th>Neto a Pagar</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="cargando">
            <td [attr.colspan]="modoSeleccion ? 11 : 10" class="td-loading">
              <div class="loading-spinner">Cargando...</div>
            </td>
          </tr>

          <tr *ngIf="!cargando && boletasPaginadas.length === 0">
            <td [attr.colspan]="modoSeleccion ? 11 : 10" class="td-empty">
              <div class="empty-state">
                <span class="empty-state__icon">ğŸ“­</span>
                <p class="empty-state__text">No se encontraron boletas</p>
              </div>
            </td>
          </tr>

          <tr *ngFor="let boleta of boletasPaginadas">
            <td *ngIf="modoSeleccion" class="td-checkbox">
              <input 
                type="checkbox" 
                class="checkbox-input"
                [checked]="estaSeleccionada(boleta)"
                (change)="toggleSeleccion(boleta)"
              />
            </td>
            <td class="td-codigo">
              <span class="codigo-badge">{{ boleta.codigo }}</span>
            </td>
            <td class="td-trabajador">
              <div class="trabajador-info">
                <span class="trabajador-info__nombre">{{ boleta.trabajadorNombre }}</span>
                <span class="trabajador-info__cargo">{{ boleta.trabajadorCargo }}</span>
              </div>
            </td>
            <td class="td-dni">{{ boleta.trabajadorDni }}</td>
            <td class="td-area">{{ boleta.trabajadorArea }}</td>
            <td class="td-periodo">{{ boleta.periodo }}</td>
            <td class="td-monto td-monto--ingreso">S/. {{ boleta.totalIngresos.toFixed(2) }}</td>
            <td class="td-monto td-monto--descuento">S/. {{ boleta.totalDescuentos.toFixed(2) }}</td>
            <td class="td-monto td-monto--neto">
              <strong>S/. {{ boleta.netoAPagar.toFixed(2) }}</strong>
            </td>
            <td class="td-estado">
              <div class="estado-container">
                <span class="badge badge--enviada-permanente" *ngIf="boleta.enviada || boleta.estado === 'Enviada'" title="Enviada por correo electrÃ³nico">
                  ğŸ“§ Enviada
                </span>
                <span class="badge badge--descargada-permanente" *ngIf="boleta.descargada && boleta.estado !== 'Enviada' && !boleta.enviada" title="Descargada">
                  ğŸ“¥ Descargada
                </span>
                <span class="badge" [ngClass]="getEstadoBadgeClass(boleta.estado)" *ngIf="boleta.estado !== 'Enviada' && !boleta.enviada && !boleta.descargada">
                  {{ boleta.estado }}
                </span>
              </div>
            </td>
            <td class="td-acciones">
              <div class="acciones-menu">
                <button 
                  class="btn-icon" 
                  title="Ver Detalle"
                  (click)="verDetalle(boleta)"
                >
                  ğŸ‘ï¸
                </button>
                <button 
                  class="btn-icon" 
                  title="Descargar PDF"
                  (click)="descargarBoleta(boleta)"
                >
                  ğŸ“¥
                </button>
                <button 
                  class="btn-icon" 
                  title="Imprimir"
                  (click)="imprimirBoleta(boleta)"
                >
                  ğŸ–¨ï¸
                </button>
                <button 
                  class="btn-icon" 
                  [title]="boleta.enviada ? 'Reenviar por Email' : 'Enviar por Email'"
                  (click)="enviarBoleta(boleta)"
                >
                  ğŸ“§
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- PAGINACION -->
    <div class="paginacion" *ngIf="totalPaginas > 1">
      <button 
        class="paginacion-btn" 
        (click)="cambiarPagina(paginaActual - 1)"
        [disabled]="paginaActual === 1"
      >
        â† Anterior
      </button>

      <div class="paginacion-numeros">
        <button
          *ngFor="let p of [].constructor(totalPaginas); let i = index"
          class="paginacion-numero"
          [class.active]="paginaActual === i + 1"
          (click)="cambiarPagina(i + 1)"
        >
          {{ i + 1 }}
        </button>
      </div>

      <button 
        class="paginacion-btn" 
        (click)="cambiarPagina(paginaActual + 1)"
        [disabled]="paginaActual === totalPaginas"
      >
        Siguiente â†’
      </button>
    </div>
  </div>

  <!-- VISTA TARJETAS -->
  <div class="tarjetas-grid" *ngIf="vistaActual === 'tarjetas'">
    <div class="boleta-card" *ngFor="let boleta of boletasPaginadas">
      <div class="boleta-card__header">
        <div class="boleta-card__checkbox" *ngIf="modoSeleccion">
          <input 
            type="checkbox" 
            class="checkbox-input"
            [checked]="estaSeleccionada(boleta)"
            (change)="toggleSeleccion(boleta)"
          />
        </div>
        <div class="boleta-card__codigo">{{ boleta.codigo }}</div>
        <span class="badge" [ngClass]="getEstadoBadgeClass(boleta.estado)">
          {{ boleta.estado }}
        </span>
      </div>

      <div class="boleta-card__body">
        <h3 class="boleta-card__trabajador">{{ boleta.trabajadorNombre }}</h3>
        <p class="boleta-card__cargo">{{ boleta.trabajadorCargo }}</p>
        <p class="boleta-card__dni">DNI: {{ boleta.trabajadorDni }}</p>

        <div class="boleta-card__periodo">
          <span class="periodo-icon">ğŸ“…</span>
          {{ boleta.periodo }}
        </div>

        <div class="boleta-card__montos">
          <div class="monto-item monto-item--ingreso">
            <span class="monto-item__label">Ingresos:</span>
            <span class="monto-item__value">S/. {{ boleta.totalIngresos.toFixed(2) }}</span>
          </div>
          <div class="monto-item monto-item--descuento">
            <span class="monto-item__label">Descuentos:</span>
            <span class="monto-item__value">S/. {{ boleta.totalDescuentos.toFixed(2) }}</span>
          </div>
          <div class="monto-item monto-item--neto">
            <span class="monto-item__label">Neto a Pagar:</span>
            <span class="monto-item__value">S/. {{ boleta.netoAPagar.toFixed(2) }}</span>
          </div>
        </div>

        <div class="boleta-card__estados">
          <span class="estado-tag" *ngIf="boleta.enviada">ğŸ“§ Enviada</span>
          <span class="estado-tag" *ngIf="boleta.descargada">ğŸ“¥ Descargada</span>
        </div>
      </div>

      <div class="boleta-card__footer">
        <button class="btn btn--sm btn--outline" (click)="verDetalle(boleta)">
          ğŸ‘ï¸ Ver Detalle
        </button>
        <button class="btn btn--sm btn--primary" (click)="descargarBoleta(boleta)">
          ğŸ“¥ Descargar
        </button>
      </div>
    </div>

    <div class="empty-state" *ngIf="boletasPaginadas.length === 0">
      <span class="empty-state__icon">ğŸ“­</span>
      <p class="empty-state__text">No se encontraron boletas</p>
    </div>
  </div>

  <!-- MODAL: DETALLE BOLETA -->
  <div class="modal modal--full" *ngIf="mostrarModalDetalle" (click)="mostrarModalDetalle = false">
    <div class="modal__content modal__content--boleta" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h3 class="modal__title">ğŸ“„ Boleta de Pago</h3>
        <div class="modal__actions">
          <button class="btn btn--sm btn--outline" (click)="imprimirBoleta(boletaSeleccionada!)">
            ğŸ–¨ï¸ Imprimir
          </button>
          <button class="btn btn--sm btn--primary" (click)="descargarBoleta(boletaSeleccionada!)">
            ğŸ“¥ Descargar PDF
          </button>
          <button class="modal__close" (click)="mostrarModalDetalle = false">âœ–ï¸</button>
        </div>
      </div>
      <div class="modal__body" *ngIf="boletaSeleccionada">
        <div class="boleta-detalle">
          <!-- HEADER DE LA BOLETA -->
          <div class="boleta-detalle__header">
            <div class="header-logo">
              <div class="logo-placeholder">ğŸ›ï¸</div>
              <div class="header-info">
                <h2>MUNICIPALIDAD DISTRITAL</h2>
                <p>Boleta de Pago Electronica</p>
              </div>
            </div>
            <div class="header-periodo">
              <span class="periodo-label">Periodo:</span>
              <span class="periodo-value">{{ boletaSeleccionada.periodo }}</span>
              <span class="codigo-boleta">{{ boletaSeleccionada.codigo }}</span>
            </div>
          </div>

          <!-- DATOS DEL TRABAJADOR -->
          <div class="boleta-detalle__seccion">
            <h3 class="seccion-title">ğŸ‘¤ Datos del Trabajador</h3>
            <div class="datos-grid">
              <div class="dato-item">
                <span class="dato-label">Nombre:</span>
                <span class="dato-value">{{ boletaSeleccionada.trabajadorNombre }}</span>
              </div>
              <div class="dato-item">
                <span class="dato-label">DNI:</span>
                <span class="dato-value">{{ boletaSeleccionada.trabajadorDni }}</span>
              </div>
              <div class="dato-item">
                <span class="dato-label">Cargo:</span>
                <span class="dato-value">{{ boletaSeleccionada.trabajadorCargo }}</span>
              </div>
              <div class="dato-item">
                <span class="dato-label">Area:</span>
                <span class="dato-value">{{ boletaSeleccionada.trabajadorArea }}</span>
              </div>
              <div class="dato-item">
                <span class="dato-label">Dias Trabajados:</span>
                <span class="dato-value">{{ boletaSeleccionada.diasTrabajados }} / {{ boletaSeleccionada.diasHabiles }}</span>
              </div>
              <div class="dato-item">
                <span class="dato-label">Horas Extras:</span>
                <span class="dato-value">{{ boletaSeleccionada.horasExtras }}</span>
              </div>
            </div>
          </div>

          <!-- DETALLE DE CONCEPTOS -->
          <div class="boleta-detalle__conceptos">
            <div class="conceptos-columna">
              <h3 class="seccion-title">ğŸ’µ Ingresos</h3>
              <div class="conceptos-lista">
                <div class="concepto-item" *ngFor="let ingreso of boletaSeleccionada.ingresos">
                  <span class="concepto-nombre">{{ ingreso.nombre }}</span>
                  <span class="concepto-monto">S/. {{ ingreso.monto.toFixed(2) }}</span>
                </div>
                <div class="concepto-item concepto-item--total">
                  <span class="concepto-nombre"><strong>Total Ingresos:</strong></span>
                  <span class="concepto-monto"><strong>S/. {{ boletaSeleccionada.totalIngresos.toFixed(2) }}</strong></span>
                </div>
              </div>
            </div>

            <div class="conceptos-columna">
              <h3 class="seccion-title">â– Descuentos</h3>
              <div class="conceptos-lista">
                <div class="concepto-item" *ngFor="let descuento of boletaSeleccionada.descuentos">
                  <span class="concepto-nombre">{{ descuento.nombre }}</span>
                  <span class="concepto-monto concepto-monto--descuento">S/. {{ descuento.monto.toFixed(2) }}</span>
                </div>
                <div class="concepto-item concepto-item--total">
                  <span class="concepto-nombre"><strong>Total Descuentos:</strong></span>
                  <span class="concepto-monto concepto-monto--descuento"><strong>S/. {{ boletaSeleccionada.totalDescuentos.toFixed(2) }}</strong></span>
                </div>
              </div>
            </div>

            <div class="conceptos-columna">
              <h3 class="seccion-title">ğŸ›ï¸ Aportes Empleador</h3>
              <div class="conceptos-lista">
                <div class="concepto-item" *ngFor="let aporte of boletaSeleccionada.aportesEmpleador">
                  <span class="concepto-nombre">{{ aporte.nombre }}</span>
                  <span class="concepto-monto">S/. {{ aporte.monto.toFixed(2) }}</span>
                </div>
                <div class="concepto-item concepto-item--total">
                  <span class="concepto-nombre"><strong>Total Aportes:</strong></span>
                  <span class="concepto-monto"><strong>S/. {{ boletaSeleccionada.totalAportesEmpleador.toFixed(2) }}</strong></span>
                </div>
              </div>
            </div>
          </div>

          <!-- NETO A PAGAR -->
          <div class="boleta-detalle__neto">
            <div class="neto-container">
              <span class="neto-label">NETO A PAGAR:</span>
              <span class="neto-monto">S/. {{ boletaSeleccionada.netoAPagar.toFixed(2) }}</span>
            </div>
          </div>

          <!-- DATOS BANCARIOS -->
          <div class="boleta-detalle__banco">
            <div class="banco-info">
              <span class="banco-label">Banco:</span>
              <span class="banco-value">{{ boletaSeleccionada.banco }}</span>
            </div>
            <div class="banco-info">
              <span class="banco-label">Cuenta:</span>
              <span class="banco-value">{{ boletaSeleccionada.numeroCuenta }}</span>
            </div>
            <div class="banco-info" *ngIf="boletaSeleccionada.cci">
              <span class="banco-label">CCI:</span>
              <span class="banco-value">{{ boletaSeleccionada.cci }}</span>
            </div>
          </div>

          <!-- PIE -->
          <div class="boleta-detalle__pie">
            <p>Este documento es una constancia de pago electronica</p>
            <p>Fecha de emision: {{ formatearFecha(boletaSeleccionada.fechaEmision) }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: ENVIO MASIVO -->
  <div class="modal" *ngIf="mostrarModalEnvio" (click)="mostrarModalEnvio = false">
    <div class="modal__content" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h3 class="modal__title">ğŸ“§ Envio Masivo de Boletas</h3>
        <button class="modal__close" (click)="mostrarModalEnvio = false">âœ–ï¸</button>
      </div>
      <div class="modal__body">
        <div class="envio-info">
          <div class="envio-info__icon">ğŸ“§</div>
          <p class="envio-info__text">
            Se enviaran <strong>{{ boletasSeleccionadas.length }}</strong> boletas por correo electronico
            a los trabajadores correspondientes.
          </p>
        </div>

        <div class="form-group">
          <label class="form-label">Asunto del correo:</label>
          <input 
            type="text" 
            class="form-input"
            value="Boleta de Pago - {{ nombreMesFiltro }} {{ filtros.anio }}"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Mensaje:</label>
          <textarea 
            class="form-textarea" 
            rows="4"
            placeholder="Mensaje adicional para los trabajadores..."
          ></textarea>
        </div>
      </div>
      <div class="modal__footer">
        <button class="btn btn--ghost" (click)="mostrarModalEnvio = false">Cancelar</button>
        <button class="btn btn--primary" (click)="confirmarEnvioMasivo()">
          ğŸ“§ Enviar {{ boletasSeleccionadas.length }} Boletas
        </button>
      </div>
    </div>
  </div>
</div>