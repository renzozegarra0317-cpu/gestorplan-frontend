<div class="boletas-pago">
  <!-- HEADER -->
  <div class="page-header">
    <div class="page-header__left">
      <h1 class="page-title">
        <span class="page-title__icon">üìÑ</span>
        Boletas de Pago
      </h1>
      <p class="page-subtitle">
        <span class="page-subtitle__dots">
          <span class="page-subtitle__dot page-subtitle__dot--large"></span>
          <span class="page-subtitle__dot page-subtitle__dot--medium"></span>
          <span class="page-subtitle__dot page-subtitle__dot--small"></span>
        </span>
        Consulta y gestion de boletas de remuneraciones
      </p>
    </div>
    <div class="page-header__right">
      <button 
        class="btn btn--sm btn--primary" 
        (click)="enviarTodasLasBoletas()"
        [disabled]="cargando || boletasFiltradas.length === 0"
        title="Enviar todas las boletas por correo electr√≥nico"
      >
        üìß Enviar Todas por Email
      </button>
      <button class="btn btn--sm btn--outline" (click)="exportarExcel()">
        üìä Exportar Excel
      </button>
      <button 
        class="btn btn--sm btn--outline" 
        (click)="modoSeleccion = !modoSeleccion"
        [class.active]="modoSeleccion"
      >
        {{ modoSeleccion ? '‚úñÔ∏è Cancelar Seleccion' : '‚òëÔ∏è Seleccion Masiva' }}
      </button>
    </div>
  </div>

  <!-- RESUMEN -->
  <div class="resumen-boletas" *ngIf="resumen">
    <div class="resumen-card resumen-card--total">
      <div class="resumen-card__icon">üìã</div>
      <div class="resumen-card__content">
        <span class="resumen-card__label">Total Boletas</span>
        <span class="resumen-card__value">{{ resumen.totalBoletas }}</span>
      </div>
    </div>

    <div class="resumen-card resumen-card--enviadas">
      <div class="resumen-card__icon">üìß</div>
      <div class="resumen-card__content">
        <span class="resumen-card__label">Enviadas</span>
        <span class="resumen-card__value">{{ resumen.boletasEnviadas }}</span>
      </div>
    </div>

    <div class="resumen-card resumen-card--descargadas">
      <div class="resumen-card__icon">üì•</div>
      <div class="resumen-card__content">
        <span class="resumen-card__label">Descargadas</span>
        <span class="resumen-card__value">{{ resumen.boletasDescargadas }}</span>
      </div>
    </div>

    <div class="resumen-card resumen-card--trabajadores">
      <div class="resumen-card__icon">üë•</div>
      <div class="resumen-card__content">
        <span class="resumen-card__label">Trabajadores</span>
        <span class="resumen-card__value">{{ resumen.totalTrabajadores }}</span>
      </div>
    </div>

    <div class="resumen-card resumen-card--neto">
      <div class="resumen-card__icon">üí∞</div>
      <div class="resumen-card__content">
        <span class="resumen-card__label">Total Neto Pagado</span>
        <span class="resumen-card__value">S/. {{ resumen.totalNetoPagado.toFixed(2) }}</span>
      </div>
    </div>
  </div>

  <!-- ACCIONES MASIVAS -->
  <div class="acciones-masivas" *ngIf="modoSeleccion && boletasSeleccionadas.length > 0">
    <div class="acciones-masivas__info">
      <span class="acciones-masivas__count">{{ boletasSeleccionadas.length }} boletas seleccionadas</span>
      <button class="btn-link" (click)="deseleccionarTodas()">Deseleccionar todas</button>
    </div>
    <div class="acciones-masivas__buttons">
      <button class="btn btn--sm btn--primary" (click)="abrirEnvioMasivo()">
        üìß Enviar por Email
      </button>
      <button class="btn btn--sm btn--outline" (click)="descargarMasivo()">
        üì• Descargar ZIP
      </button>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="filtros-section">
    <div class="filtros-header">
      <div class="filtros-header__left">
        <h3 class="filtros-title">üîç Filtros de Busqueda</h3>
      </div>
      <div class="filtros-header__right">
        <div class="vista-toggle">
          <button 
            class="btn btn--sm btn--view-toggle" 
            [class.active]="vistaActual === 'lista'"
            (click)="vistaActual = 'lista'"
          >
            üìã Lista
          </button>
          <button 
            class="btn btn--sm btn--view-toggle" 
            [class.active]="vistaActual === 'tarjetas'"
            (click)="vistaActual = 'tarjetas'"
          >
            üóÇÔ∏è Tarjetas
          </button>
        </div>
        <button class="btn btn--ghost btn--sm" (click)="limpiarFiltros()">
          ‚úñÔ∏è Limpiar
        </button>
      </div>
    </div>

    <div class="filtros-grid">
      <div class="filtro-item">
        <label class="filtro-label">A√±o:</label>
        <select class="filtro-select" [(ngModel)]="filtros.anio" (change)="onFiltroChange()">
          <option *ngFor="let anio of anios" [value]="anio">{{ anio }}</option>
        </select>
      </div>

      <div class="filtro-item">
        <label class="filtro-label">Mes:</label>
        <select class="filtro-select" [(ngModel)]="filtros.mes" (change)="onFiltroChange()">
          <option *ngFor="let mes of mesesBoletas" [value]="mes.valor">{{ mes.nombre }}</option>
        </select>
      </div>

      <div class="filtro-item">
        <label class="filtro-label">Estado:</label>
        <select class="filtro-select" [(ngModel)]="filtros.estado" (change)="onFiltroChange()">
          <option *ngFor="let estado of estadosBoleta" [value]="estado">{{ estado }}</option>
        </select>
      </div>

      <div class="filtro-item">
        <label class="filtro-label">Area:</label>
        <select class="filtro-select" [(ngModel)]="filtros.area" (change)="onFiltroChange()">
          <option *ngFor="let area of areas" [value]="area">{{ area }}</option>
        </select>
      </div>

      <div class="filtro-item filtro-item--search">
        <div class="search-box-wrapper">
          <label class="filtro-label">Buscar:</label>
          <div class="search-box">
            <span class="search-box__icon">üîç</span>
            <input
              type="text"
              class="search-box__input"
              placeholder="Buscar por DNI, nombre, codigo..."
              [(ngModel)]="filtros.busqueda"
              (input)="onBusquedaChange()"
            />
          </div>
        </div>
        <span class="resultado-texto">
          Mostrando <strong>{{ boletasFiltradas.length }}</strong> boletas
          <span *ngIf="filtros.mes !== 0"> de <strong>{{ nombreMesFiltro }}</strong></span>
          <strong>{{ filtros.anio }}</strong>
        </span>
      </div>
    </div>
  </div>

  <!-- VISTA LISTA -->
  <div class="tabla-container" *ngIf="vistaActual === 'lista'">
    <div class="tabla-scroll">
      <table class="tabla">
        <thead>
          <tr>
            <th *ngIf="modoSeleccion">
              <input 
                type="checkbox" 
                class="checkbox-input"
                [checked]="boletasSeleccionadas.length === boletasPaginadas.length && boletasPaginadas.length > 0"
                (change)="$event.target.checked ? seleccionarTodas() : deseleccionarTodas()"
              />
            </th>
            <th>Codigo</th>
            <th>Trabajador</th>
            <th>DNI</th>
            <th>Area</th>
            <th>Periodo</th>
            <th>Total Ingresos</th>
            <th>Total Descuentos</th>
            <th>Neto a Pagar</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="cargando">
            <td [attr.colspan]="modoSeleccion ? 11 : 10" class="td-loading">
              <div class="loading-spinner">Cargando...</div>
            </td>
          </tr>

          <tr *ngIf="!cargando && boletasPaginadas.length === 0">
            <td [attr.colspan]="modoSeleccion ? 11 : 10" class="td-empty">
              <div class="empty-state">
                <span class="empty-state__icon">üì≠</span>
                <p class="empty-state__text">No se encontraron boletas</p>
              </div>
            </td>
          </tr>

          <tr *ngFor="let boleta of boletasPaginadas">
            <td *ngIf="modoSeleccion" class="td-checkbox">
              <input 
                type="checkbox" 
                class="checkbox-input"
                [checked]="estaSeleccionada(boleta)"
                (change)="toggleSeleccion(boleta)"
              />
            </td>
            <td class="td-codigo">
              <span class="codigo-badge">{{ boleta.codigo }}</span>
            </td>
            <td class="td-trabajador">
              <div class="trabajador-info">
                <span class="trabajador-info__nombre">{{ boleta.trabajadorNombre }}</span>
                <span class="trabajador-info__cargo">{{ boleta.trabajadorCargo }}</span>
              </div>
            </td>
            <td class="td-dni">{{ boleta.trabajadorDni }}</td>
            <td class="td-area">{{ boleta.trabajadorArea }}</td>
            <td class="td-periodo">{{ boleta.periodo }}</td>
            <td class="td-monto td-monto--ingreso">S/. {{ boleta.totalIngresos.toFixed(2) }}</td>
            <td class="td-monto td-monto--descuento">S/. {{ boleta.totalDescuentos.toFixed(2) }}</td>
            <td class="td-monto td-monto--neto">
              <strong>S/. {{ boleta.netoAPagar.toFixed(2) }}</strong>
            </td>
            <td class="td-estado">
              <div class="estado-container">
                <span class="badge badge--enviada-permanente" *ngIf="boleta.enviada || boleta.estado === 'Enviada'" title="Enviada por correo electr√≥nico">
                  üìß Enviada
                </span>
                <span class="badge badge--descargada-permanente" *ngIf="boleta.descargada && boleta.estado !== 'Enviada' && !boleta.enviada" title="Descargada">
                  üì• Descargada
                </span>
                <span class="badge" [ngClass]="getEstadoBadgeClass(boleta.estado)" *ngIf="boleta.estado !== 'Enviada' && !boleta.enviada && !boleta.descargada">
                  {{ boleta.estado }}
                </span>
              </div>
            </td>
            <td class="td-acciones">
              <div class="acciones-menu">
                <button 
                  class="btn-icon" 
                  title="Ver Detalle"
                  (click)="verDetalle(boleta)"
                >
                  üëÅÔ∏è
                </button>
                <button 
                  class="btn-icon" 
                  title="Descargar PDF"
                  (click)="descargarBoleta(boleta)"
                >
                  üì•
                </button>
                <button 
                  class="btn-icon" 
                  title="Imprimir"
                  (click)="imprimirBoleta(boleta)"
                >
                  üñ®Ô∏è
                </button>
                <button 
                  class="btn-icon" 
                  [title]="boleta.enviada ? 'Reenviar por Email' : 'Enviar por Email'"
                  (click)="enviarBoleta(boleta)"
                >
                  üìß
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- PAGINACION -->
    <div class="paginacion" *ngIf="totalPaginas > 1">
      <button 
        class="paginacion-btn" 
        (click)="cambiarPagina(paginaActual - 1)"
        [disabled]="paginaActual === 1"
      >
        ‚Üê Anterior
      </button>

      <div class="paginacion-numeros">
        <button
          *ngFor="let p of [].constructor(totalPaginas); let i = index"
          class="paginacion-numero"
          [class.active]="paginaActual === i + 1"
          (click)="cambiarPagina(i + 1)"
        >
          {{ i + 1 }}
        </button>
      </div>

      <button 
        class="paginacion-btn" 
        (click)="cambiarPagina(paginaActual + 1)"
        [disabled]="paginaActual === totalPaginas"
      >
        Siguiente ‚Üí
      </button>
    </div>
  </div>

  <!-- VISTA TARJETAS -->
  <div class="tarjetas-grid" *ngIf="vistaActual === 'tarjetas'">
    <div class="boleta-card" *ngFor="let boleta of boletasPaginadas">
      <div class="boleta-card__header">
        <div class="boleta-card__checkbox" *ngIf="modoSeleccion">
          <input 
            type="checkbox" 
            class="checkbox-input"
            [checked]="estaSeleccionada(boleta)"
            (change)="toggleSeleccion(boleta)"
          />
        </div>
        <div class="boleta-card__codigo">{{ boleta.codigo }}</div>
        <span class="badge" [ngClass]="getEstadoBadgeClass(boleta.estado)">
          {{ boleta.estado }}
        </span>
      </div>

      <div class="boleta-card__body">
        <h3 class="boleta-card__trabajador">{{ boleta.trabajadorNombre }}</h3>
        <p class="boleta-card__cargo">{{ boleta.trabajadorCargo }}</p>
        <p class="boleta-card__dni">DNI: {{ boleta.trabajadorDni }}</p>

        <div class="boleta-card__periodo">
          <span class="periodo-icon">üìÖ</span>
          {{ boleta.periodo }}
        </div>

        <div class="boleta-card__montos">
          <div class="monto-item monto-item--ingreso">
            <span class="monto-item__label">Ingresos:</span>
            <span class="monto-item__value">S/. {{ boleta.totalIngresos.toFixed(2) }}</span>
          </div>
          <div class="monto-item monto-item--descuento">
            <span class="monto-item__label">Descuentos:</span>
            <span class="monto-item__value">S/. {{ boleta.totalDescuentos.toFixed(2) }}</span>
          </div>
          <div class="monto-item monto-item--neto">
            <span class="monto-item__label">Neto a Pagar:</span>
            <span class="monto-item__value">S/. {{ boleta.netoAPagar.toFixed(2) }}</span>
          </div>
        </div>

        <div class="boleta-card__estados">
          <span class="estado-tag" *ngIf="boleta.enviada">üìß Enviada</span>
          <span class="estado-tag" *ngIf="boleta.descargada">üì• Descargada</span>
        </div>
      </div>

      <div class="boleta-card__footer">
        <button class="btn btn--sm btn--outline" (click)="verDetalle(boleta)">
          üëÅÔ∏è Ver Detalle
        </button>
        <button class="btn btn--sm btn--primary" (click)="descargarBoleta(boleta)">
          üì• Descargar
        </button>
      </div>
    </div>

    <div class="empty-state" *ngIf="boletasPaginadas.length === 0">
      <span class="empty-state__icon">üì≠</span>
      <p class="empty-state__text">No se encontraron boletas</p>
    </div>
  </div>

  <!-- MODAL: DETALLE BOLETA -->
  <div class="modal modal--full" *ngIf="mostrarModalDetalle" (click)="mostrarModalDetalle = false">
    <div class="modal__content modal__content--boleta" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h3 class="modal__title">üìÑ Boleta de Pago</h3>
        <div class="modal__actions">
          <button class="btn btn--sm btn--outline" (click)="imprimirBoleta(boletaSeleccionada!)">
            üñ®Ô∏è Imprimir
          </button>
          <button class="btn btn--sm btn--primary" (click)="descargarBoleta(boletaSeleccionada!)">
            üì• Descargar PDF
          </button>
          <button class="modal__close" (click)="mostrarModalDetalle = false">‚úñÔ∏è</button>
        </div>
      </div>
      <div class="modal__body modal__body--boleta" *ngIf="boletaSeleccionada">
        <div class="boleta-pago-container">
          <!-- HEADER DE LA BOLETA -->
          <div class="boleta-header">
            <div class="boleta-header-left">
              <div class="boleta-direccion">Av. La Ribera N¬∞ 165 - Huanchaco</div>
              <div class="boleta-ruc">R.U.C. 20167736468</div>
            </div>
            <div class="boleta-header-center">
              <h1 class="boleta-titulo">Municipalidad Distrital de Huanchaco</h1>
              <div class="boleta-subtitulo">BOLETA DE PAGO</div>
            </div>
            <div class="boleta-header-right">
              <img src="assets/escudo.png" alt="Escudo de Huanchaco" class="boleta-logo">
            </div>
          </div>

          <!-- DATOS DEL TRABAJADOR -->
          <div class="boleta-datos-trabajador">
            <div class="datos-columna-izq">
              <div class="dato-fila">
                <span class="dato-numero">{{ boletaSeleccionada.trabajadorId || '1' }}</span>
              </div>
              <div class="dato-fila">
                <span class="dato-label">Apellidos y Nombres:</span>
                <span class="dato-valor">{{ boletaSeleccionada.trabajadorNombre }}</span>
              </div>
              <div class="dato-fila">
                <span class="dato-label">Fecha de Ingreso:</span>
                <span class="dato-valor">{{ formatearFecha(boletaSeleccionada.fechaIngreso) || formatearFecha(boletaSeleccionada.fechaGeneracion) }}</span>
              </div>
              <div class="dato-fila">
                <span class="dato-label">Ocupaci√≥n √≥ Cargo:</span>
                <span class="dato-valor">{{ boletaSeleccionada.trabajadorCargo }}</span>
              </div>
              <div class="dato-fila">
                <span class="dato-label">D√≠as Trabajados:</span>
                <span class="dato-valor">{{ boletaSeleccionada.diasTrabajados }}</span>
              </div>
            </div>
            <div class="datos-columna-der">
              <div class="dato-fila">
                <span class="dato-label">D.N.I</span>
                <span class="dato-valor">{{ boletaSeleccionada.trabajadorDni }}</span>
              </div>
              <div class="dato-fila">
                <span class="dato-label">ESSALUD:</span>
                <span class="dato-valor">{{ boletaSeleccionada.codigoEssalud || '0' }}</span>
              </div>
              <div class="dato-fila">
                <span class="dato-label">AFILIACION:</span>
                <span class="dato-valor">{{ obtenerAfiliacion(boletaSeleccionada) }}</span>
              </div>
              <div class="dato-fila">
                <span class="dato-label">CUSPP :</span>
                <span class="dato-valor">{{ boletaSeleccionada.cuspp || '-' }}</span>
              </div>
              <div class="dato-fila">
                <span class="dato-label">CONDICION:</span>
                <span class="dato-valor">{{ boletaSeleccionada.condicion || 'FUNCIONARIO' }}</span>
              </div>
              <div class="dato-fila">
                <span class="dato-label">MES DE PAGO:</span>
                <span class="dato-valor">{{ obtenerNombreMes(boletaSeleccionada.mes) }}</span>
              </div>
              <div class="dato-fila">
                <span class="dato-label">A√ëO</span>
                <span class="dato-valor">{{ boletaSeleccionada.anio }}</span>
              </div>
            </div>
          </div>

          <!-- SECCI√ìN PRINCIPAL: INGRESOS, DESCUENTOS, APORTES -->
          <div class="boleta-conceptos">
            <!-- COLUMNA INGRESOS -->
            <div class="conceptos-columna conceptos-columna--ingresos">
              <div class="conceptos-header">
                <h3 class="conceptos-titulo">INGRESOS S/.</h3>
              </div>
              <div class="conceptos-lista">
                <div class="concepto-fila" *ngFor="let ingreso of boletaSeleccionada.ingresos">
                  <span class="concepto-nombre">{{ ingreso.nombre }}</span>
                  <span class="concepto-monto">{{ formatearMonto(ingreso.monto) }}</span>
                </div>
                <div class="concepto-fila concepto-fila--subtotal">
                  <span class="concepto-nombre">Sub-Total de Ingresos</span>
                  <span class="concepto-monto">{{ formatearMonto(boletaSeleccionada.totalIngresos) }}</span>
                </div>
              </div>
            </div>

            <!-- COLUMNA DESCUENTOS -->
            <div class="conceptos-columna conceptos-columna--descuentos">
              <div class="conceptos-header">
                <h3 class="conceptos-titulo">DESCUENTOS S/.</h3>
              </div>
              <div class="conceptos-lista">
                <div class="concepto-fila" *ngFor="let descuento of boletaSeleccionada.descuentos">
                  <span class="concepto-nombre">{{ descuento.nombre }}</span>
                  <span class="concepto-monto">{{ formatearMonto(descuento.monto) }}</span>
                </div>
                <div class="concepto-fila concepto-fila--subtotal" *ngIf="boletaSeleccionada.descuentos.length === 0">
                  <span class="concepto-nombre">SNP 13%</span>
                  <span class="concepto-monto">0,00</span>
                </div>
                <div class="concepto-fila concepto-fila--subtotal">
                  <span class="concepto-nombre">TOTAL DESCUENTO S/.</span>
                  <span class="concepto-monto">{{ formatearMonto(boletaSeleccionada.totalDescuentos) }}</span>
                </div>
              </div>
            </div>

            <!-- COLUMNA APORTES -->
            <div class="conceptos-columna conceptos-columna--aportes">
              <div class="conceptos-header">
                <h3 class="conceptos-titulo">APORTES S/.</h3>
              </div>
              <div class="conceptos-lista">
                <div class="concepto-fila" *ngFor="let aporte of boletaSeleccionada.aportesEmpleador">
                  <span class="concepto-nombre">{{ aporte.nombre }}</span>
                  <span class="concepto-monto">{{ formatearMonto(aporte.monto) }}</span>
                </div>
                <div class="concepto-fila concepto-fila--subtotal" *ngIf="boletaSeleccionada.aportesEmpleador.length === 0">
                  <span class="concepto-nombre">ESSALUD 9%</span>
                  <span class="concepto-monto">{{ formatearMonto(boletaSeleccionada.totalAportesEmpleador) }}</span>
                </div>
                <div class="concepto-fila concepto-fila--subtotal">
                  <span class="concepto-nombre">TOTAL APORTES</span>
                  <span class="concepto-monto">{{ formatearMonto(boletaSeleccionada.totalAportesEmpleador) }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- TOTALES -->
          <div class="boleta-totales">
            <div class="total-fila">
              <span class="total-label">TOTAL INGRESOS S/.</span>
              <span class="total-valor">{{ formatearMonto(boletaSeleccionada.totalIngresos) }}</span>
            </div>
            <div class="total-fila">
              <span class="total-label">TOTAL DESCUENTO S/.</span>
              <span class="total-valor">{{ formatearMonto(boletaSeleccionada.totalDescuentos) }}</span>
            </div>
            <div class="total-fila">
              <span class="total-label">TOTAL APORTES</span>
              <span class="total-valor">{{ formatearMonto(boletaSeleccionada.totalAportesEmpleador) }}</span>
            </div>
          </div>

          <!-- NETO A PAGAR -->
          <div class="boleta-neto">
            <div class="neto-box">
              <span class="neto-label">NETO A PAGAR S/.</span>
              <span class="neto-valor">S/ {{ formatearMonto(boletaSeleccionada.netoAPagar) }}</span>
            </div>
          </div>

          <!-- FOOTER -->
          <div class="boleta-footer">
            <div class="footer-left">OFIC. RECURSOS HUMANOS</div>
            <div class="footer-right">--&lt; Trabajador(a) &gt;---</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: ENVIO MASIVO -->
  <div class="modal" *ngIf="mostrarModalEnvio" (click)="mostrarModalEnvio = false">
    <div class="modal__content" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h3 class="modal__title">üìß Envio Masivo de Boletas</h3>
        <button class="modal__close" (click)="mostrarModalEnvio = false">‚úñÔ∏è</button>
      </div>
      <div class="modal__body">
        <div class="envio-info">
          <div class="envio-info__icon">üìß</div>
          <p class="envio-info__text">
            Se enviaran <strong>{{ boletasSeleccionadas.length }}</strong> boletas por correo electronico
            a los trabajadores correspondientes.
          </p>
        </div>

        <div class="form-group">
          <label class="form-label">Asunto del correo:</label>
          <input 
            type="text" 
            class="form-input"
            value="Boleta de Pago - {{ nombreMesFiltro }} {{ filtros.anio }}"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Mensaje:</label>
          <textarea 
            class="form-textarea" 
            rows="4"
            placeholder="Mensaje adicional para los trabajadores..."
          ></textarea>
        </div>
      </div>
      <div class="modal__footer">
        <button class="btn btn--ghost" (click)="mostrarModalEnvio = false">Cancelar</button>
        <button class="btn btn--primary" (click)="confirmarEnvioMasivo()">
          üìß Enviar {{ boletasSeleccionadas.length }} Boletas
        </button>
      </div>
    </div>
  </div>
</div>